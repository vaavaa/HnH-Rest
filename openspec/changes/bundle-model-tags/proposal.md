# Bundle Model Tags — теги на бандлах и фильтрация по модели

**Repo**: HnH-Rest  
**Change ID**: `bundle-model-tags`  
**Branch**: `spec/bundle-model-tags`  
**Date**: 2026-02-23  
**Status**: Proposed  

Спецификация добавляет привязку промпт-бандлов к типу модели (или нескольким) через теги и фильтрацию входящих запросов render по одному основному тегу (`model_type`).

---

## Проблема

Тонкая настройка промптов зависит от целевой LLM: один и тот же логический бандл может использоваться для нескольких моделей или, в будущем, иметь разные варианты шаблонов под разные модели. Сейчас в БД и API нет понятия «для какой модели» предназначен бандл — нельзя ни явно указать это при создании бандла, ни отфильтровать запросы render по модели.

---

## Цель

1. **Теги на bundle** — у каждого бандла есть список тегов (например `["gpt-4o", "default"]` или `["claude-3-opus"]`). Один бандл может обслуживать несколько моделей.
2. **В render передавать основной тег** — в теле `POST /v1/prompts/render` добавить опциональное поле `model_type`. При выборе бандла требовать, что у бандла в `tags` присутствует этот тег; иначе — **400** с телом ошибки (код `bundle_unsupported_model`).
3. **Обратная совместимость** — если `model_type` не передан или пустая строка, поведение как сейчас (бандл по `bundle_id` + `semver` без проверки тегов). При миграции существующие бандлы получают только пустой массив тегов `[]`.
4. **Расширяемость** — позже можно ввести отдельные строки бандлов с разными `tags` (и разными `template_id`) без смены уникальности на `(bundle_id, semver, model_type)`; текущая уникальность `(bundle_id, semver)` сохраняется.

---

## Что меняется

- **БД**: в таблицу `prompt_bundle` добавляется поле `tags` (JSONB). Не входит в уникальный ключ.
- **API**:  
  - создание бандла — опциональное поле `tags: list[str]`;  
  - ответы чтения бандла — включают `tags`;  
  - render — опциональное поле `model_type: str | None`; при указании — проверка «model_type in bundle.tags».
- **Поведение**: при render с переданным непустым `model_type` бандл считается валидным только если в его `tags` есть значение `model_type`; иначе возвращается **400** с телом `{ "detail": "...", "code": "bundle_unsupported_model" }`.

Никаких изменений контракта шаблонов, порядка сборки или формата audit.

---

## Не входит в этот change

- Теги на уровне шаблонов (PromptTemplate).
- Уникальность по `(bundle_id, semver, model_type)` или отдельная таблица «вариантов по модели».
- Обязательность `model_type` в render (остаётся опциональной для совместимости).
